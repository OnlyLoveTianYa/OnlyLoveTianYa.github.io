---
layout: post
title:  智能服务解决方案
date:   2023-03-09 22:10:00 +0800
categories: [超时,故障]
---

* content
{:toc}

## 问题背景
在现代应用开发中，我们可能会遇到这些情况导致的系统问题，比如超时未配置、没有弱依赖降级能力、核心接口未限流等导致系统崩溃等问题。
其中，超时未配置是一个常见的问题。当我们的应用请求某个服务时，如果服务响应时间过长，请求就会一直阻塞，占用资源直到超时，而这通常会导致线程池被打满，引发故障。
另一个常见的问题是系统没有弱依赖降级能力，我们的应用可能会依赖一些弱依赖服务，在这些依赖服务出现故障或不可用的情况下，如果我们没有降级能力，自身应用和业务也会收到影响。
最后一个问题是CPU占用过高。这通常是由于营销活动导致的流量尖峰，而为了解决这个问题，我们需要在应用中设置一些限流策略，从而控制请求的频率和并发量，防止系统崩溃或CPU占用过高。
而经过以往故障分类的统计数据，故障原因是上述的原因引发的故障数占比 __30%__ 左右。

## 定义问题
解决以上问题的关键就在于合理的配置。这里主要有三步要走

1.发现: 哪些问题需要配置?

2.修复: 怎么配置? 配什么值比较合理?

3.验证: 如何知道配置了是有用的？

## 穿山甲是什么
穿山甲是一款定位于帮助应用owner发现应用配置问题并快速修复的一套方案，它提供了应用接口超时时间配置管理、应用接口降级配置能力、应用限流配置管理、应用强弱依赖预案配置等多种功能，帮助我们更好地配置应用，提高应用的稳定性和易维护性。

### 整体方案
*整体设计图
![img.png]({{ '/styles/images/pangolinDesignPic.png' | prepend: site.baseurl }})

### 穿山甲解法
#### 1.发现: 哪些问题需要配置?
* __穿山甲看板__ 穿山甲通过近端SDK采集应用接口日志调用数据，日志通过TT回流数据到ODPS生成[穿山甲FBI看板]，提供给应用owner发现配置问题
* __sunfire告警__ 通过sunfire采集近端SDK实时日志数据，配置告警通知应用 owner 配置问题
* __技术风险平台__ 打通技术风险平台接口发现应用弱依赖等

#### 2.修复: 怎么配置? 配什么值比较合理?
* __钉钉机器人__ 通过发送配置指令给钉钉机器人，机器人通过穿山甲服务端写入配置数据到diamond中
* __diamond__ 也可通过直接修改diamond配置来完成配置
* __什么值合理__ 穿山甲server打通 emonitor sentinel拉取应用接口耗时限流配置数据提供给应用owner 来参考
  ![img.png]({{ '/styles/images/pangolinPic1.png' | prepend: site.baseurl }})

#### 3.验证: 如何知道配置了是有用的？
* __钉钉机器人__ 机器人实时反馈配置结果
* __穿山甲看板__ 通过T+1看板数据反馈结果
* __sunfire监控__ 通过sunfire监控观察如降级接口实时降级流量

#### 核心原理
客户端
1.通过diamond来存储超时降级数据， 利用diamond listener机制来获取最新的穿山甲机器人指令
2.穿山甲SDK通过实现HSF client filter 的机制来实现 来重设超时时间， 降级接口调用.
3.通过日志打印， TT采集回流数据报表来写入穿山甲报表
服务端
1.通过钉钉智能机器人打通钉钉指令到服务端指令处理接口写入diamond数据
2.通过定时任务采集接入应用的sentinel， emonitor数据 通过日志打印 TT采集数据写入穿山甲报表
3.通过强弱依赖降级预案协议生成强弱依赖降级配置数据

### 使用示例
#### 超时管理能力
* 主动发现
  穿山甲近端SDK通过采样应用HSF接口调用， 提供应用接口超时数据看板给应用owner发现超时问题
  并且对有HSF接口超时时间不合理(>=3000ms)的应用， 会通过钉钉群告警通知到应用owner.
  ![img.png]({{ '/styles/images/pangolinWarn.png' | prepend: site.baseurl }})
* 配置简便
  应用owner发现或者收到告警通知后， 只需@穿山甲机器人 发送超时配置指令即可完成接口超时时间配置
  ![img.png]({{ '/styles/images/pangolinWarn1.png' | prepend: site.baseurl }})
* 配置参考
  穿山甲server 会拉取应用接口耗时数据提供给应用owner 参考来配置合理的超时时间
  ![img.png]({{ '/styles/images/pangolinPic2.png' | prepend: site.baseurl }})
* 全局拦截
  穿山甲近端SDK不仅可以配置应用本身使用的HSF接口超时， 应用使用的近端包里使用的HSF接口也可以设置对应的超时时间
#### 降级能力
降级能力用于对HSF接口的降级， 当应用消费的HSF接口出现问题时， 为了防止问题扩大， 如果接口是弱依赖， 往往需要降级掉对应的HSF接口
* 支持强弱依赖预案生成
  穿山甲支持强弱依赖链路弱依赖预案生成， 对于应用的HSF弱依赖， 可以生成对应的HSF依赖降级预案， 通过降级预案可以快速降级出现问题的HSF服务
  ![img.png]({{ '/styles/images/pangolinPic3.png' | prepend: site.baseurl }})
* 降级数据收集
  使用穿山甲降级会提供被降级接口的详细数据看板 比如接口降级了多少次等数据
  ![img.png]({{ '/styles/images/pangolinPic4.png' | prepend: site.baseurl }})

#### 限流管理能力(sentinel)
* 穿山甲与sentinel 打通数据， 目前可以获取sentinel 配置的系统保护与限流配置信息 后续也会增加钉钉机器人配置能力
  ![img.png]({{ '/styles/images/pangolinPic5.png' | prepend: site.baseurl }})

### 落地效果
目前穿山甲SDK已经接入本地生活_消费者技术部下的核心应用 20+ 发现并处理不合理配置 102 条， 已配置近百条弱依赖降级预案，接入 3K+ 限流数据配置查看。目前提供的超时配置管理和强弱依赖降级预案能力减少了应用owner 维护成本与应用风险。

### 未来展望
穿山甲未来会继续致力于提升应用稳定性与易维护性提升，探索更多除了超时降级限流以外的场景，增强不合理配置的修复效率。也欢迎其他团队来接入体验使用反馈。